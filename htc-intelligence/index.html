<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTC Market Intelligence</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #0066cc;
            --bg: #f4f7fe;
            --text: #2b3674;
            --green: #05cd99;
            --red: #e31a1a;
            --gray: #a3aed0;
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; }
        * { box-sizing: border-box; }

        /* é¡¶éƒ¨å¯¼èˆª */
        header { background: white; height: 64px; padding: 0 30px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 50; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .logo { font-size: 20px; font-weight: 800; color: var(--primary); display: flex; gap: 8px; align-items: center; }

        /* ä¸»å¸ƒå±€ */
        .layout { max-width: 1400px; margin: 24px auto; display: grid; grid-template-columns: 1fr 360px; gap: 24px; padding: 0 20px; }

        /* --- æ ¸å¿ƒå‡çº§ï¼šé«˜ç®¡ä»ªè¡¨ç›˜æ§åˆ¶å° --- */
        .controls {
            grid-column: 1/-1;
            background: white;
            padding: 20px 25px;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
        }

        /* 1. è®¡æ•°å™¨è¡Œ */
        .counter-box { display: flex; align-items: center; gap: 10px; font-size: 13px; font-weight: 600; color: var(--text); border-bottom: 1px solid #f0f0f0; padding-bottom: 12px; margin-bottom: 5px;}
        .count-badge { background: #eef2ff; color: var(--primary); padding: 4px 10px; border-radius: 6px; font-size: 14px; font-weight: 800; }

        /* 2. ç­›é€‰è¡Œ */
        .filter-row { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .filter-label { font-size: 12px; font-weight: 700; color: var(--gray); text-transform: uppercase; min-width: 85px; }

        /* æŒ‰é’® Pills */
        .pill {
            border: 1px solid #e0e5f2;
            background: white;
            padding: 8px 16px;
            border-radius: 30px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text);
            cursor: pointer;
            transition: 0.2s;
        }
        .pill:hover { border-color: var(--primary); color: var(--primary); background: #f8faff; }

        /* æ¿€æ´»çŠ¶æ€ï¼šæ™®é€š Tab */
        .pill.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 10px rgba(0,102,204,0.2); }

        /* æ¿€æ´»çŠ¶æ€ï¼šåˆ©å¥½ (ç»¿) */
        .pill.pos { color: var(--green); border-color: #e0fbf4; }
        .pill.pos.active { background: var(--green); color: white; border-color: var(--green); box-shadow: 0 4px 10px rgba(5,205,153,0.2); }

        /* æ¿€æ´»çŠ¶æ€ï¼šå¨èƒ (çº¢) */
        .pill.neg { color: var(--red); border-color: #ffe5e5; }
        .pill.neg.active { background: var(--red); color: white; border-color: var(--red); box-shadow: 0 4px 10px rgba(227,26,26,0.2); }

        /* æ¿€æ´»çŠ¶æ€ï¼šæ”¶è— (ç²‰) */
        .pill.fav.active { background: #ff5b5b; color: white; border-color: #ff5b5b; }

        /* --- å¡ç‰‡è®¾è®¡ --- */
        .news-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        .card { background: white; border-radius: 16px; padding: 20px; display: flex; flex-direction: column; box-shadow: 0 4px 10px rgba(0,0,0,0.02); transition: 0.2s; cursor: pointer; border: 2px solid transparent; position: relative; }
        .card:hover { transform: translateY(-4px); box-shadow: 0 15px 30px rgba(0,0,0,0.08); }
        .card.selected { border-color: var(--primary); background: #f4faff; }

        /* æ ‡ç­¾è¡Œ */
        .tags-row { display: flex; flex-wrap: wrap; gap: 6px; }
        .tag { font-size: 10px; padding: 4px 8px; border-radius: 4px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; }
        .tag.industry { background: #E6F0FF; color: #0052cc; }

        /* æƒ…æ„Ÿæ ‡ç­¾é¢œè‰² */
        .tag.pos { background: #E6F7F1; color: #00B69B; } /* ç»¿åº•ç»¿å­— */
        .tag.neg { background: #FFF0F0; color: #E31A1A; } /* çº¢åº•çº¢å­— */
        .tag.neu { background: #F4F7FE; color: #858D9D; } /* ç°åº•ç°å­— */

        .card-title { font-size: 16px; font-weight: 700; margin: 0 0 10px 0; line-height: 1.5; color: #1B2559; }
        .card-summary { font-size: 13px; color: #707EAE; line-height: 1.6; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; flex-grow: 1; }

        .insight { background: linear-gradient(90deg, #F4F7FE 0%, #ffffff 100%); border-left: 4px solid var(--primary); padding: 12px; border-radius: 0 8px 8px 0; margin-top: 15px; }
        .insight h4 { margin: 0 0 5px 0; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--primary); }
        .insight p { margin: 0; font-size: 12px; color: #2B3674; font-weight: 500; }

        .footer { margin-top: 15px; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #f0f0f0; padding-top: 10px; font-size: 11px; color: #A3AED0; }

        /* Sidebar & Lang */
        .sidebar { position: sticky; top: 100px; height: fit-content; }
        .panel { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); }
        .gen-btn { width: 100%; background: var(--primary); color: white; padding: 14px; border-radius: 12px; border: none; font-weight: 700; margin-top: 20px; cursor: pointer; transition: 0.2s; box-shadow: 0 4px 10px rgba(0,102,204,0.3); }
        .gen-btn:hover { background: #0052cc; transform: translateY(-2px); }

        .lang-switch { background: #f4f7fe; padding: 4px; border-radius: 20px; display: flex; }
        .lang-btn { border: none; background: transparent; padding: 6px 14px; border-radius: 16px; font-size: 12px; font-weight: 700; color: #a0aec0; cursor: pointer; }
        .lang-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        @media (max-width: 1000px) { .layout { grid-template-columns: 1fr; } .sidebar { display: none; } }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <i class="fas fa-radar" style="color:var(--primary)"></i>
            <span data-t="brand">HTC Intelligence</span>
        </div>
        <div class="lang-switch">
            <button class="lang-btn active" onclick="setLang('cn')">ä¸­æ–‡</button>
            <button class="lang-btn" onclick="setLang('en')">EN</button>
        </div>
    </header>

    <div class="layout">
        <div class="controls">
            <div class="counter-box">
                <i class="fas fa-chart-pie" style="color:var(--primary)"></i>
                <span id="counterText">Loading data...</span>
                <div style="flex-grow:1"></div>
                <select id="monthSelect" style="padding:6px 12px; border-radius:8px; border:1px solid #e0e0e0; outline:none; font-size:12px; background:#f9f9f9; cursor:pointer;">
                    <option value="all">ğŸ“… All Time</option>
                </select>
            </div>

            <div class="filter-row">
                <span class="filter-label" data-t="lbl_cat">Category:</span>
                <button class="pill active" data-group="cat" data-val="all" data-t="all">All News</button>
                <button class="pill" data-group="cat" data-val="Outbound Trend" data-t="cat_out">Outbound Trend</button>
                <button class="pill" data-group="cat" data-val="Consumption Trend" data-t="cat_con">Consumption</button>
                <button class="pill" data-group="cat" data-val="Short Haul" data-t="cat_sh">Short Haul</button>
                <button class="pill" data-group="cat" data-val="Long Haul" data-t="cat_lh">Long Haul</button>
            </div>

            <div class="filter-row">
                <span class="filter-label" data-t="lbl_sent">Sentiment:</span>
                <button class="pill active" data-group="sent" data-val="all" data-t="all">All</button>
                <button class="pill pos" data-group="sent" data-val="pos" data-t="sent_pos">Positive</button>
                <button class="pill neg" data-group="sent" data-val="neg" data-t="sent_neg">Threat</button>
                <div style="flex-grow:1"></div>
                <button class="pill fav" data-group="fav" onclick="toggleFavFilter(this)" data-t="fav">
                    <i class="fas fa-heart"></i> Favorites
                </button>
            </div>
        </div>

        <div class="news-grid" id="grid"></div>

        <aside class="sidebar">
            <div class="panel">
                <h3 data-t="rep_title">Executive Summary</h3>
                <p data-t="rep_desc" style="font-size:13px; color:var(--gray);">Select items to generate report.</p>
                <div id="selCount" style="color:var(--primary); font-weight:800; font-size:18px; margin:15px 0;">0 items</div>
                <div style="height:1px; background:#f0f0f0; margin-bottom:15px;"></div>
                <div id="reportOut" style="font-size:12px; color:#555; white-space:pre-wrap; max-height:300px; overflow-y:auto;"></div>
                <button class="gen-btn" onclick="generateReport()" data-t="btn_gen">Generate Report</button>
            </div>
        </aside>
    </div>

    <script>
        // ç¿»è¯‘å­—å…¸
        const I18N = {
            cn: {
                brand: "HTC å¸‚åœºæƒ…æŠ¥ä¸­å¿ƒ",
                lbl_cat: "å¸‚åœºåˆ†ç±»:", lbl_sent: "æƒ…æ„Ÿç­›é€‰:",
                all: "å…¨éƒ¨æƒ…æŠ¥",
                cat_out: "å‡ºå¢ƒæ¸¸è¶‹åŠ¿", cat_con: "æ¶ˆè´¹è¶‹åŠ¿", cat_sh: "çŸ­çº¿ç«å¯¹", cat_lh: "é•¿çº¿ç«å¯¹",
                sent_pos: "åˆ©å¥½æ¶ˆæ¯", sent_neg: "å¨èƒ/è­¦æŠ¥", sent_neu: "ä¸­ç«‹", fav: "æˆ‘çš„æ”¶è—",
                rep_title: "é«˜ç®¡æ‘˜è¦æŠ¥å‘Š", rep_desc: "å‹¾é€‰æ–°é—»ä»¥ç”Ÿæˆæˆ˜ç•¥æŠ¥å‘Š", btn_gen: "ç”ŸæˆæŠ¥å‘Š",
                add: "åŠ å…¥æŠ¥å‘Š", orig: "æ¥æº", insight: "HTC æ´å¯Ÿ",
                count_fmt: "æ€»è®¡ {total} æ¡ï¼Œæ˜¾ç¤º <span class='count-badge'>{shown}</span> æ¡",
                loading: "æ­£åœ¨è¿æ¥æƒ…æŠ¥ä¸­å¿ƒ..."
            },
            en: {
                brand: "HTC Intelligence",
                lbl_cat: "Category:", lbl_sent: "Sentiment:",
                all: "All News",
                cat_out: "Outbound Trend", cat_con: "Consumption", cat_sh: "Short Haul", cat_lh: "Long Haul",
                sent_pos: "Positive", sent_neg: "Threat/Alert", sent_neu: "Neutral", fav: "Favorites",
                rep_title: "Executive Summary", rep_desc: "Select items for report", btn_gen: "Generate Report",
                add: "Add to Report", orig: "Source", insight: "HTC Insight",
                count_fmt: "Total {total} items, showing <span class='count-badge'>{shown}</span>",
                loading: "Loading Intelligence..."
            }
        };

        let CUR_LANG = 'cn';
        let NEWS = [], FILTERED = [], SELECTED = new Set();
        let FILTERS = { cat: 'all', sent: 'all', month: 'all', fav: false };

        window.onload = async () => { initMonths(); await fetchNews(); setLang('cn'); };

        function initMonths() {
            const sel = document.getElementById('monthSelect');
            const now = new Date();
            for(let i=0; i<6; i++) {
                const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
                const val = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
                sel.add(new Option(d.toLocaleDateString(undefined, {year:'numeric',month:'short'}), val));
            }
            sel.onchange = (e) => { FILTERS.month = e.target.value; applyFilters(); };
        }

        async function fetchNews() {
            try {
                const res = await fetch('/api/news');
                const json = await res.json();
                if (json.success) {
                    NEWS = json.data.sort((a,b) => new Date(b.date) - new Date(a.date));
                    applyFilters();
                }
            } catch(e) {}
        }

        function applyFilters() {
            FILTERED = NEWS.filter(n => {
                // 1. æ”¶è—è¿‡æ»¤
                if (FILTERS.fav) return n.isFavorite;

                // 2. æ ¸å¿ƒåˆ†ç±»è¿‡æ»¤ (Tab)
                const cats = (n.categories || []).join('|');
                let catMatch = FILTERS.cat === 'all';
                if (!catMatch) {
                    // å¦‚æœæ–°é—»åŒ…å«è¯¥å¤§ç±»æ ‡ç­¾ï¼Œæˆ–è€…å±äºè¯¥å¤§ç±»çš„å­é›†
                    catMatch = cats.includes(FILTERS.cat);
                }

                // 3. æƒ…æ„Ÿè¿‡æ»¤
                const s = (n.sentiment || '').toLowerCase();
                let sentMatch = FILTERS.sent === 'all';
                if (!sentMatch) {
                    if (FILTERS.sent === 'pos') sentMatch = s.includes('positive') || s.includes('åˆ©å¥½');
                    else if (FILTERS.sent === 'neg') sentMatch = s.includes('negative') || s.includes('threat') || s.includes('å¨èƒ');
                    // é»˜è®¤å…¶ä»–ä¸ºä¸­ç«‹ï¼Œæš‚ä¸ä¸¥å¡ä¸­ç«‹
                }

                // 4. æœˆä»½è¿‡æ»¤
                const monthMatch = FILTERS.month === 'all' ||
                    (n.date && n.date.substring(0, 7) === FILTERS.month);

                return catMatch && sentMatch && monthMatch;
            });
            render(FILTERED);
        }

        function render(list) {
            const T = I18N[CUR_LANG];

            // æ›´æ–°è®¡æ•°å™¨
            const counterHtml = T.count_fmt.replace('{total}', NEWS.length).replace('{shown}', list.length);
            document.getElementById('counterText').innerHTML = counterHtml;

            const grid = document.getElementById('grid');
            if(list.length === 0) {
                grid.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:40px;">${T.loading}</div>`;
                return;
            }

            grid.innerHTML = list.map(item => {
                const title = CUR_LANG==='cn' ? (item.title_cn||item.title) : item.title;
                const summary = CUR_LANG==='cn' ? (item.summary_cn||item.summary) : item.summary;
                const insight = CUR_LANG==='cn' ? (item.insight_cn||item.insight) : (item.insight_en||item.insight);

                // æƒ…æ„Ÿé¢œè‰²åˆ¤å®š (å¼ºåˆ¶ä¿®å¤ç™½è‰²é—®é¢˜)
                const s = (item.sentiment || '').toLowerCase();
                let color = 'neu', label = T.sent_neu;
                if (s.includes('neg') || s.includes('threat') || s.includes('å¨èƒ')) { color='neg'; label=T.sent_neg; }
                else if (s.includes('pos') || s.includes('åˆ©å¥½')) { color='pos'; label=T.sent_pos; }

                // è¡Œä¸šæ ‡ç­¾ (Industry Tags) - è¿‡æ»¤æ‰å¤§ç±»æ ‡ç­¾ï¼Œåªç•™ç»†åˆ†
                const bigCats = ['Short Haul', 'Long Haul', 'Consumption Trend', 'Outbound Trend', 'Market Trend'];
                const tags = (item.categories||[]).filter(c => !bigCats.includes(c)).slice(0,3)
                    .map(c => `<span class="tag industry">${c}</span>`).join('');

                return `
                <div class="card ${SELECTED.has(item._id)?'selected':''}" onclick="window.open('${item.url}')">
                    <div class="tags-row">
                        <span class="tag ${color}">${label}</span>
                        ${tags}
                    </div>
                    <div class="card-title">${title}</div>
                    <div class="card-summary">${summary}</div>
                    <div class="insight">
                        <h4><i class="fas fa-lightbulb"></i> ${T.insight}</h4>
                        <p>${insight}</p>
                    </div>
                    <div class="footer" onclick="event.stopPropagation()">
                        <label style="display:flex; gap:6px; align-items:center; cursor:pointer; font-weight:600; color:var(--text);">
                            <input type="checkbox" onchange="toggleSel('${item._id}')" ${SELECTED.has(item._id)?'checked':''}> ${T.add}
                        </label>
                        <span style="color:var(--primary)">${T.orig} &rarr;</span>
                    </div>
                </div>`;
            }).join('');
        }

        // æŒ‰é’®ç‚¹å‡»é€»è¾‘
        document.querySelectorAll('.pill').forEach(btn => {
            if(btn.dataset.group === 'fav') return; // æ”¶è—æŒ‰é’®å•ç‹¬å¤„ç†
            btn.onclick = (e) => {
                const group = e.target.dataset.group;
                const val = e.target.dataset.val;
                // è®°å½•çŠ¶æ€
                FILTERS[group] = val;

                // UI åˆ‡æ¢ (åŒç»„äº’æ–¥)
                document.querySelectorAll(`.pill[data-group="${group}"]`).forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');

                applyFilters();
            };
        });

        window.toggleFavFilter = (btn) => {
            FILTERS.fav = !FILTERS.fav;
            btn.classList.toggle('active');
            applyFilters();
        };

        window.setLang = (l) => {
            CUR_LANG = l;
            document.querySelectorAll('.lang-btn').forEach(b => b.classList.toggle('active', b.innerText.toLowerCase().includes(l==='cn'?'ä¸­':'en')));
            document.querySelectorAll('[data-t]').forEach(el => el.innerText = I18N[l][el.dataset.t]);
            render(FILTERED);
        };

        window.toggleSel = (id) => {
            if(SELECTED.has(id)) SELECTED.delete(id); else SELECTED.add(id);
            document.getElementById('selCount').innerText = `${SELECTED.size} items`;
            render(FILTERED);
        };

        // æˆ˜ç•¥æŠ¥å‘Šç”Ÿæˆ (è°ƒç”¨åç«¯ AI)
        window.generateReport = async () => {
            // 1. è·å–é€‰ä¸­æ–°é—»
            const selItems = NEWS.filter(n => SELECTED.has(n._id));

            if(selItems.length === 0) {
                alert('è¯·å…ˆå‹¾é€‰æ–°é—» (Please select news first)');
                return;
            }

            const reportBox = document.getElementById('reportOut');
            const btn = document.querySelector('.gen-btn');

            // 2. æ˜¾ç¤º"æ­£åœ¨æ€è€ƒ"åŠ¨ç”»
            reportBox.innerHTML = `
                <div style="text-align:center; padding:30px; color:var(--primary);">
                    <i class="fas fa-circle-notch fa-spin" style="font-size:24px;"></i>
                    <div style="margin-top:10px; font-weight:bold;">Generating Strategy...</div>
                    <div style="font-size:12px; color:#aaa; margin-top:5px;">Analyzing Competitors (Short/Long Haul) & Consumer Trends</div>
                </div>
            `;
            btn.disabled = true;
            btn.style.opacity = 0.7;

            try {
                // 3. è°ƒç”¨åç«¯ api/report.js
                const res = await fetch('/api/report', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ items: selItems })
                });

                const json = await res.json();

                if (json.success) {
                    // 4. æ¸²æŸ“ Markdown (ç¾åŒ–ç‰ˆ)
                    let html = json.report
                        // å¤„ç†æ ‡é¢˜
                        .replace(/^# (.*$)/gim, '<h1 style="font-size:18px; color:#2b3674; border-bottom:2px solid #eee; padding-bottom:10px; margin-bottom:15px;">$1</h1>')
                        .replace(/^## (.*$)/gim, '<h2 style="font-size:15px; color:var(--primary); margin-top:20px; margin-bottom:10px;">$1</h2>')
                        .replace(/^### (.*$)/gim, '<h3 style="font-size:13px; color:#444; font-weight:800; margin-top:15px; margin-bottom:5px;">$1</h3>')
                        // å¤„ç†åŠ ç²—
                        .replace(/\*\*(.*?)\*\*/g, '<strong style="color:#2b3674;">$1</strong>')
                        // å¤„ç†åˆ—è¡¨
                        .replace(/^\- (.*$)/gim, '<li style="margin-left:20px; margin-bottom:4px;">$1</li>')
                        // å¤„ç†æ¢è¡Œ
                        .replace(/\n/g, '<br>');

                    reportBox.innerHTML = `<div style="line-height:1.6; font-family:'Segoe UI', sans-serif; font-size:13px; color:#333;">${html}</div>`;
                } else {
                    reportBox.innerText = "Error: Report generation failed.";
                }
            } catch (e) {
                console.error(e);
                reportBox.innerText = "Network Error. Please try again.";
            } finally {
                btn.disabled = false;
                btn.style.opacity = 1;
            }
        };
    </script>
</body>
</html>