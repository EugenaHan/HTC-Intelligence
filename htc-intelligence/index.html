<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTC Market Intelligence - China Outbound Tourism</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --primary: #0066cc;
            --primary-dark: #004d99;
            --secondary: #00a8e8;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
            --light: #f8f9fa;
            --dark: #343a40;
            --gray: #6c757d;
            --border: #dee2e6;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
            --shadow-lg: 0 4px 20px rgba(0,0,0,0.15);
            --radius: 12px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Noto Sans SC', 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--dark);
        }

        .container { max-width: 1600px; margin: 0 auto; padding: 20px; }

        /* Header */
        header {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: var(--radius);
            padding: 20px 30px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-lg);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .logo-section { display: flex; align-items: center; gap: 15px; }

        .logo {
            width: 50px; height: 50px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 24px;
        }

        .title-section h1 { font-size: 22px; font-weight: 700; color: var(--dark); margin-bottom: 3px; }
        .title-section p { color: var(--gray); font-size: 12px; }

        /* User Section */
        .user-section { display: flex; align-items: center; gap: 15px; }

        .user-info {
            display: flex; align-items: center; gap: 10px;
            background: var(--light); padding: 8px 15px;
            border-radius: 20px;
        }

        .user-avatar {
            width: 32px; height: 32px;
            background: var(--primary); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 14px;
        }

        .user-name { font-size: 14px; font-weight: 500; }

        .btn {
            padding: 8px 16px; border: none; border-radius: 8px;
            font-size: 14px; font-weight: 500; cursor: pointer;
            transition: all 0.3s ease; display: inline-flex;
            align-items: center; gap: 6px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .btn-primary:hover { transform: translateY(-2px); box-shadow: var(--shadow); }

        .btn-outline {
            background: white; border: 2px solid var(--border);
            color: var(--dark);
        }

        .btn-outline:hover { border-color: var(--primary); color: var(--primary); }

        /* Login Modal */
        .modal {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; background: rgba(0,0,0,0.5);
            z-index: 1000; align-items: center; justify-content: center;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: white; border-radius: var(--radius);
            padding: 30px; width: 90%; max-width: 400px;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            display: flex; justify-content: space-between;
            align-items: center; margin-bottom: 20px;
        }

        .modal-header h2 { font-size: 20px; }

        .close-btn {
            background: none; border: none; font-size: 24px;
            cursor: pointer; color: var(--gray);
        }

        .form-group { margin-bottom: 15px; }

        .form-group label {
            display: block; font-size: 13px;
            font-weight: 500; margin-bottom: 5px;
        }

        .form-group input {
            width: 100%; padding: 10px 12px;
            border: 2px solid var(--border); border-radius: 8px;
            font-size: 14px;
        }

        .form-group input:focus {
            outline: none; border-color: var(--primary);
        }

        /* Stats */
        .stats-section { display: flex; gap: 20px; }

        .stat-item { text-align: center; }

        .stat-value {
            font-size: 28px; font-weight: 700;
            color: var(--primary);
        }

        .stat-label { font-size: 10px; color: var(--gray); text-transform: uppercase; }

        /* Filters */
        .filters-section {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: var(--radius);
            padding: 15px 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .filters-row { display: flex; flex-wrap: wrap; gap: 15px; align-items: center; }

        .filter-group { display: flex; flex-direction: column; gap: 5px; }

        .filter-label { font-size: 11px; font-weight: 600; color: var(--gray); text-transform: uppercase; }

        .filter-buttons { display: flex; gap: 8px; flex-wrap: wrap; }

        .filter-btn {
            padding: 6px 14px; border: 2px solid var(--border);
            background: white; border-radius: 20px;
            cursor: pointer; font-size: 13px; font-weight: 500;
            transition: all 0.3s ease;
        }

        .filter-btn:hover { border-color: var(--primary); color: var(--primary); }

        .filter-btn.active { background: var(--primary); border-color: var(--primary); color: white; }

        /* Main Layout */
        .main-layout { display: grid; grid-template-columns: 1fr 420px; gap: 20px; }

        /* News Grid */
        .news-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 15px; }

        /* News Card */
        .news-card {
            background: white; border-radius: var(--radius);
            box-shadow: var(--shadow); overflow: hidden;
            transition: all 0.3s ease; display: flex;
            flex-direction: column; position: relative;
        }

        .news-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-lg); }

        .card-header {
            padding: 15px 15px 10px;
            display: flex; justify-content: space-between;
            align-items: flex-start; gap: 10px;
        }

        .card-categories { display: flex; flex-wrap: wrap; gap: 5px; flex: 1; }

        .category-tag {
            padding: 3px 8px; border-radius: 10px;
            font-size: 10px; font-weight: 600; text-transform: uppercase;
        }

        .tag-outbound { background: #f3e5f5; color: #7b1fa2; }
        .tag-consumption { background: #fff8e1; color: #f57c00; }
        .tag-economy { background: #e8f5e9; color: #2e7d32; }
        .tag-short { background: #ffebee; color: #c62828; }
        .tag-long { background: #e3f2fd; color: #1565c0; }
        .tag-visa { background: #fff3e0; color: #e65100; }
        .tag-flight { background: #e0f7fa; color: #00838f; }
        .tag-market { background: #e8eaf6; color: #3f51b5; }

        /* Sentiment selector: same tier as category tags, button group */
        .sentiment-selector {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .sentiment-tag {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            border: 1px solid transparent;
            cursor: pointer;
            background: #e9ecef;
            color: #495057;
        }
        .sentiment-tag:hover { opacity: 0.9; }
        .sentiment-tag--positive { color: #155724; }
        .sentiment-tag--positive.active { background: #d4edda; color: #155724; }
        .sentiment-tag--neutral { color: #383d41; }
        .sentiment-tag--neutral.active { background: #e2e3e5; color: #383d41; }
        .sentiment-tag--negative { color: #721c24; }
        .sentiment-tag--negative.active { background: #f8d7da; color: #721c24; }

        .card-body { padding: 0 15px 10px; flex: 1; }

        .news-title {
            font-size: 14px; font-weight: 600;
            color: var(--dark); margin-bottom: 6px;
            line-height: 1.4; cursor: pointer;
        }

        .news-title:hover { color: var(--primary); }

        .news-summary { font-size: 12px; color: var(--gray); line-height: 1.5; margin-bottom: 10px; }

        /* HTC Strategic Insight section */
        .insight-section {
            margin: 10px 0;
            padding: 10px 12px;
            border-radius: 8px;
            background: #e8f4fc;
            border-left: 3px solid #0d6efd;
        }
        .insight-section .insight-header {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            font-weight: 600;
            color: #0d6efd;
            margin-bottom: 6px;
        }
        .insight-section .insight-text {
            font-size: 12px;
            color: #1a1a1a;
            line-height: 1.5;
        }
        .insight-section .insight-placeholder {
            font-size: 12px;
            color: #6c757d;
            font-style: italic;
        }

        .news-meta { display: flex; gap: 10px; font-size: 11px; color: var(--gray); }

        .meta-item { display: flex; align-items: center; gap: 4px; }

        .card-actions {
            padding: 10px 15px; background: #f8f9fa;
            border-top: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }

        .favorite-btn {
            background: none; border: none; cursor: pointer;
            font-size: 18px; color: var(--gray);
            transition: all 0.3s ease;
        }

        .favorite-btn:hover { color: var(--danger); }

        .favorite-btn.active { color: var(--danger); }

        .left-actions { display: flex; align-items: center; gap: 10px; }

        .add-report-btn {
            border: 1px solid var(--border);
            background: white;
            color: var(--dark);
            font-size: 11px;
            padding: 6px 10px;
            border-radius: 999px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .add-report-btn:hover { border-color: var(--primary); color: var(--primary); }

        .add-report-btn.active {
            border-color: var(--success);
            color: var(--success);
            background: rgba(40, 167, 69, 0.08);
        }

        .report-checkbox {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: var(--dark);
            cursor: pointer;
            user-select: none;
        }
        .report-checkbox input { cursor: pointer; accent-color: var(--primary); }

        .read-more {
            font-size: 12px; color: var(--primary);
            text-decoration: none; display: flex;
            align-items: center; gap: 4px;
        }

        .read-more:hover { text-decoration: underline; }

        /* Report Panel */
        .report-panel {
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(10px);
            border-radius: var(--radius);
            padding: 20px; box-shadow: var(--shadow-lg);
            height: fit-content; position: sticky; top: 20px;
        }

        .report-header {
            display: flex; align-items: center; gap: 10px;
            margin-bottom: 15px; padding-bottom: 12px;
            border-bottom: 2px solid var(--border);
        }

        .report-header i { font-size: 20px; color: var(--primary); }

        .report-header h2 { font-size: 16px; font-weight: 700; }

        .report-content {
            font-family: 'Inter', monospace; font-size: 11px;
            line-height: 1.6; color: var(--dark);
            background: #f8f9fa; padding: 15px;
            border-radius: 8px; border-left: 3px solid var(--primary);
            max-height: 500px; overflow-y: auto; white-space: pre-wrap;
            margin-bottom: 15px;
        }
        .report-content.report-markdown { white-space: normal; }
        .report-content.report-markdown h2 { font-size: 13px; margin: 12px 0 6px; font-weight: 700; }
        .report-content.report-markdown h3 { font-size: 12px; margin: 8px 0 4px; font-weight: 600; }
        .report-content.report-markdown ul { margin: 6px 0; padding-left: 18px; }
        .report-content.report-markdown p { margin: 4px 0; }
        .report-content.report-markdown strong { font-weight: 600; }

        .copy-btn {
            width: 100%; padding: 10px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white; border: none; border-radius: 8px;
            font-size: 13px; font-weight: 600; cursor: pointer;
            transition: all 0.3s ease;
            display: flex; align-items: center; justify-content: center; gap: 6px;
        }

        .copy-btn:hover { transform: translateY(-2px); box-shadow: var(--shadow); }

        .generate-report-btn {
            width: 100%; padding: 10px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white; border: none; border-radius: 8px;
            font-size: 13px; font-weight: 600; cursor: pointer;
            margin-bottom: 12px; transition: all 0.3s ease;
            display: flex; align-items: center; justify-content: center; gap: 6px;
        }
        .generate-report-btn:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
        .generate-report-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

        /* Loading */
        .loading {
            text-align: center; padding: 40px; color: white;
        }

        .loading i { font-size: 40px; animation: spin 1s linear infinite; }

        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* Empty State */
        .empty-state { text-align: center; padding: 40px 20px; color: white; }

        .empty-state i { font-size: 48px; margin-bottom: 15px; opacity: 0.8; }

        /* Footer */
        footer { text-align: center; padding: 20px; color: rgba(255,255,255,0.7); font-size: 11px; }

        /* Responsive */
        @media (max-width: 1200px) {
            .main-layout { grid-template-columns: 1fr; }
            .report-panel { position: static; }
        }

        @media (max-width: 768px) {
            .header-content { flex-direction: column; text-align: center; }
            .stats-section { justify-content: center; }
            .news-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo">
                        <i class="fas fa-globe-asia"></i>
                    </div>
                    <div class="title-section">
                        <h1>HTC Market Intelligence</h1>
                        <p>China Outbound Tourism Competitive Analysis | Automated & Real-time</p>
                    </div>
                </div>
                <div class="user-section" id="userSection">
                    <!-- User info will be inserted here -->
                </div>
            </div>
        </header>

        <!-- Filters -->
        <div class="filters-section">
            <div class="filters-row">
                <div class="filter-group">
                    <span class="filter-label">Market Segment</span>
                    <div class="filter-buttons" id="segmentFilters">
                        <button class="filter-btn active" data-segment="all">All</button>
                        <button class="filter-btn" data-segment="‰∏≠ÂõΩÂá∫Â¢ÉÊ∏∏Ë∂ãÂäø">Âá∫Â¢ÉÊ∏∏Ë∂ãÂäø</button>
                        <button class="filter-btn" data-segment="‰∏≠ÂõΩÊ∂àË¥πË∂ãÂäø">Ê∂àË¥πË∂ãÂäø</button>
                        <button class="filter-btn" data-segment="‰∏≠ÂõΩÁªèÊµéË∂ãÂäø">ÁªèÊµéË∂ãÂäø</button>
                        <button class="filter-btn" data-segment="Short Haul">Short Haul</button>
                        <button class="filter-btn" data-segment="Long Haul">Long Haul</button>
                    </div>
                </div>
                <div class="filter-group">
                    <span class="filter-label">View</span>
                    <div class="filter-buttons">
                        <button class="filter-btn" id="showFavoritesBtn">
                            <i class="fas fa-heart"></i> My Favorites
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Layout -->
        <div class="main-layout">
            <!-- News Grid -->
            <div class="news-grid" id="newsGrid">
                <div class="loading">
                    <i class="fas fa-spinner"></i>
                    <p>Loading news...</p>
                </div>
            </div>

            <!-- Report Panel -->
            <div class="report-panel">
                <div class="report-header">
                    <i class="fas fa-file-alt"></i>
                    <h2>Market Intelligence Executive Summary</h2>
                </div>
                <button class="generate-report-btn" id="generateReportBtn" onclick="generateEnglishReport()">
                    <i class="fas fa-file-alt"></i> Generate Report
                </button>
                <div class="report-content" id="reportContent">Select news (checkbox) and click Generate Report.</div>
                <button class="copy-btn" onclick="copyReport()">
                    <i class="fas fa-copy"></i> Copy Report
                </button>
            </div>
        </div>

        <!-- Empty State -->
        <div class="empty-state" id="emptyState" style="display: none;">
            <i class="fas fa-inbox"></i>
            <h3>No News Found</h3>
            <p>Try adjusting your filters</p>
        </div>

        <!-- Footer -->
        <footer>
            <p>HTC Market Intelligence System | Automated Daily Updates | 24/7 Online</p>
        </footer>
    </div>

    <!-- Login Modal -->
    <div class="modal" id="loginModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Sign In</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div id="loginForm">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="loginEmail" placeholder="Enter your username" autocomplete="username">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" placeholder="Enter your password" autocomplete="current-password">
                </div>
                <button class="btn btn-primary" style="width: 100%;" onclick="handleLogin()">
                    <i class="fas fa-sign-in-alt"></i> Sign In
                </button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api';
        const USER_STORAGE_KEY = 'htc_user';

        // State
        let currentUser = null;
        let currentSegment = 'all';
        let newsData = [];
        let favorites = [];
        let showFavoritesOnly = false;
        // Áä∂ÊÄÅÔºöÁî®Êà∑ÂãæÈÄâÁî®‰∫éÊä•ÂëäÁöÑÊñ∞ÈóªÔºàÂ≠ò _idÔºâÔºåÁ≠â‰ª∑‰∫é selectedNews ÁöÑ ID ÈõÜÂêà
        const selectedForReport = new Set();
        // ÂΩìÂâçÊä•ÂëäÁöÑÂÆåÊï¥Ëã±ÊñáÁ∫ØÊñáÊú¨Ôºå‰æõ Copy Report ‰ΩøÁî®
        let lastReportPlainTextEn = '';
        // ÁÇπÂáª Generate Report ÂêéËøîÂõûÁöÑËã±ÊñáÊä•ÂëäÂÜÖÂÆπÔºàÈÄâÊã©ÂèòÂåñÊó∂Ê∏ÖÁ©∫Ôºâ
        let generatedReportContent = '';

        // DOM Elements
        const newsGrid = document.getElementById('newsGrid');
        const emptyState = document.getElementById('emptyState');
        const reportContent = document.getElementById('reportContent');
        const userSection = document.getElementById('userSection');
        const loginModal = document.getElementById('loginModal');

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            const saved = localStorage.getItem(USER_STORAGE_KEY);
            if (saved) {
                try {
                    currentUser = JSON.parse(saved);
                } catch (e) {
                    localStorage.removeItem(USER_STORAGE_KEY);
                }
            }
            updateUserSection();
            if (currentUser && currentUser.uid) loadFavorites();
            checkAPIHealth();
            loadNews();
        });

        async function checkAPIHealth() {
            try {
                const response = await fetch(`${API_URL}/health`);
                const result = await response.json();
                console.log('API Health:', result);
            } catch (error) {
                console.error('API Health Check Failed:', error);
            }
        }

        function updateUserSection() {
            if (currentUser) {
                const displayName = (currentUser.email || currentUser.name || 'User').split('@')[0];
                userSection.innerHTML = `
                    <div class="user-info">
                        <div class="user-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <span class="user-name">${displayName}</span>
                    </div>
                    <button class="btn btn-outline" onclick="handleLogout()">
                        <i class="fas fa-sign-out-alt"></i> Sign Out
                    </button>
                `;
            } else {
                userSection.innerHTML = `
                    <button class="btn btn-primary" onclick="openModal()">
                        <i class="fas fa-sign-in-alt"></i> Sign In
                    </button>
                `;
            }
        }

        // Modal functions
        function openModal() { loginModal.classList.add('active'); }
        function closeModal() { loginModal.classList.remove('active'); }

        // ÁôªÂΩïÔºöPOST /api/loginÔºåÂèëÈÄÅ username ‰∏é passwordÔºà‰∏é MongoDB users Â≠óÊÆµ‰∏ÄËá¥Ôºâ
        async function handleLogin() {
            const username = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            if (!username || !password) {
                alert('Please enter username and password.');
                return;
            }
            try {
                const response = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const result = await response.json();
                if (result.success && result.user) {
                    currentUser = result.user;
                    localStorage.setItem(USER_STORAGE_KEY, JSON.stringify(currentUser));
                    closeModal();
                    updateUserSection();
                    if (currentUser.uid) loadFavorites();
                    renderNews();
                } else {
                    alert(result.message || 'Sign in failed.');
                }
            } catch (error) {
                alert('Sign in failed: ' + (error.message || 'Network error'));
            }
        }

        function handleLogout() {
            currentUser = null;
            localStorage.removeItem(USER_STORAGE_KEY);
            favorites = [];
            updateUserSection();
            renderNews();
        }

        // Load news from API
        async function loadNews() {
            try {
                // Âä†ËΩΩÊñ∞ÈóªÔºöGET /api/news
                console.log('Fetching news from:', `${API_URL}/news`);
                const response = await fetch(`${API_URL}/news`);
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                console.log('Response data:', result);
                
                if (result.success) {
                    newsData = result.data;
                    renderNews();
                } else {
                    throw new Error(result.message || 'Failed to load news');
                }
            } catch (error) {
                console.error('Error loading news:', error);
                newsGrid.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-circle"></i>
                        <h3>Failed to load news</h3>
                        <p>${error.message}</p>
                        <button class="btn btn-primary" onclick="loadNews()" style="margin-top: 15px;">
                            <i class="fas fa-sync"></i> Retry
                        </button>
                    </div>
                `;
            }
        }

        // Load user favorites
        async function loadFavorites() {
            if (!currentUser) return;
            
            try {
                const response = await fetch(`${API_URL}/favorites?userId=${currentUser.uid}`);
                const result = await response.json();
                
                if (result.success) {
                    favorites = result.data;
                    renderNews();
                }
            } catch (error) {
                console.error('Error loading favorites:', error);
            }
        }

        // Toggle favorite
        async function toggleFavorite(newsId) {
            if (!currentUser) {
                alert('Please sign in to save favorites');
                openModal();
                return;
            }
            
            const isFav = favorites.includes(newsId);
            
            try {
                if (isFav) {
                    await fetch(`${API_URL}/favorites`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId: currentUser.uid, newsId })
                    });
                    favorites = favorites.filter(id => id !== newsId);
                } else {
                    await fetch(`${API_URL}/favorites`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ userId: currentUser.uid, newsId })
                    });
                    favorites.push(newsId);
                }
                
                renderNews();
            } catch (error) {
                console.error('Error toggling favorite:', error);
            }
        }

        // Generate full English report (template)
        function generateReport() {
            let filtered = newsData;
            if (currentSegment !== 'all') {
                filtered = filtered.filter(n => n.categories.includes(currentSegment));
            }
            filtered = [...filtered].sort((a, b) => parseDateSafe(b.date) - parseDateSafe(a.date));

            const shortHaul = filtered.filter(n => n.categories.includes('Short Haul'));
            const longHaul = filtered.filter(n => n.categories.includes('Long Haul'));
            const outboundTrend = filtered.filter(n => n.categories.includes('‰∏≠ÂõΩÂá∫Â¢ÉÊ∏∏Ë∂ãÂäø'));
            const consumptionTrend = filtered.filter(n => n.categories.includes('‰∏≠ÂõΩÊ∂àË¥πË∂ãÂäø'));

            let report = `MONTHLY REPORT ‚Äî China Outbound Tourism Competitive Analysis\n`;
            report += `Generated: ${new Date().toISOString().slice(0, 10)}\n\n`;
            report += `EXECUTIVE SUMMARY\n\n`;
            report += `This report summarizes competitive developments in China outbound travel: short-haul and long-haul destinations, visa and route updates, and strategic implications for Hawaii.\n\n`;
            report += `COMPETITIVE ENVIRONMENT\n\n`;
            report += `SHORT HAUL\n\n`;

            if (shortHaul.length > 0) {
                shortHaul.forEach(news => {
                    report += `‚Ä¢\t${news.summary || news.title}\n`;
                    report += `\tDate: ${news.date} | Source: ${news.source}\n\n`;
                });
            } else {
                report += `‚Ä¢\tNo significant Short Haul updates this period.\n\n`;
            }

            report += `LONG HAUL\n\n`;
            if (longHaul.length > 0) {
                longHaul.forEach(news => {
                    report += `‚Ä¢\t${news.summary || news.title}\n`;
                    report += `\tDate: ${news.date} | Source: ${news.source}\n\n`;
                });
            } else {
                report += `‚Ä¢\tNo significant Long Haul updates this period.\n\n`;
            }

            report += `CONSUMER AND TRAVEL TRENDS\n\n`;
            [...outboundTrend, ...consumptionTrend].forEach(news => {
                report += `‚Ä¢\t${news.summary || news.title}\n`;
                report += `\tDate: ${news.date} | Source: ${news.source}\n\n`;
            });

            report += `STRATEGIC IMPLICATIONS FOR HAWAII\n`;
            report += `‚Ä¢\tSoutheast Asia's visa-free policies pose strong competition\n`;
            report += `‚Ä¢\tJapan's decline creates opportunity via Korea transit routes\n`;
            report += `‚Ä¢\tAustralia/NZ expanding direct flights ‚Äî differentiate through culture\n`;
            report += `‚Ä¢\tMiddle East gaining popularity with visa-free access\n`;
            report += `‚Ä¢\tHTA must intensify advocacy for streamlined US visa processing\n`;

            return report;
        }

        // Preset logic: turn one news item into English report fields (date, entities, action, key data, summary)
        function formatNewsItemForReportEn(news) {
            const text = `${news.title || ''} ${news.summary || ''} ${(news.insight || '')}`.toLowerCase();
            const entities = [];
            const entityKeywords = [
                { keys: ['china eastern', 'air china', 'china southern', 'hainan airlines', 'xiamen air', 'cathay', 'airline'], tag: 'Airlines' },
                { keys: ['visit japan', 'japan tourism', 'tat', 'thailand tourism', 'tourism australia', 'tourisme france', 'tourism board', 'roadshow'], tag: 'Tourism boards / DMOs' },
                { keys: ['ctrip', 'trip.com', 'fliggy', 'meituan', 'ota'], tag: 'OTAs / platforms' }
            ];
            entityKeywords.forEach(({ keys, tag }) => {
                if (keys.some(k => text.includes(k))) entities.push(tag);
            });
            if (entities.length === 0) entities.push('Market / industry');

            let action = 'Market update';
            if (/\b(route|resumption|flight|direct|nonstop|launch)\b/.test(text)) action = 'Route launch / resumption';
            else if (/\b(visa|visa-free|visa free)\b/.test(text)) action = 'Visa / visa-free policy';
            else if (/\b(roadshow|partnership|agreement|sign|mou)\b/.test(text)) action = 'Roadshow / partnership / agreement';
            else if (/\b(statistic|data|arrival|growth|percent|%\s*\d|\d+\s*%)\b/.test(text)) action = 'Data / statistics release';

            const keyData = [];
            const numMatch = text.match(/(\d+(?:\.\d+)?\s*%|\d+\s*(?:million|million|bn|billion|thousand))/gi);
            if (numMatch) keyData.push(...numMatch.slice(0, 3));
            const summaryLine = (news.insight && news.insight.trim()) ? news.insight.trim() : (news.summary || news.title || '').trim();

            return {
                date: news.date || '',
                entities: [...new Set(entities)].join(', '),
                action,
                keyData: keyData.length ? keyData.join('; ') : '‚Äî',
                summaryLine: summaryLine.slice(0, 400) + (summaryLine.length > 400 ? '...' : ''),
                source: news.source || ''
            };
        }

        // Build plain-text English report for selected items (for display + copy)
        function buildSelectedReportPlainEn(selectedList) {
            if (!selectedList.length) return 'No items selected for report.';
            let out = `MONTHLY REPORT ‚Äî Selected Items\n`;
            out += `Generated: ${new Date().toISOString().slice(0, 10)}\n\n`;
            out += `EXECUTIVE SUMMARY\n\n`;
            selectedList.forEach((news, i) => {
                const f = formatNewsItemForReportEn(news);
                out += `‚Ä¢ Date: ${f.date} | Entities: ${f.entities} | Action: ${f.action} | Key data: ${f.keyData}\n`;
                out += `  Summary: ${f.summaryLine}\n`;
                out += `  Source: ${f.source}\n\n`;
            });
            out += `STRATEGIC IMPLICATIONS FOR HAWAII\n`;
            out += `‚Ä¢ Southeast Asia's visa-free policies pose strong competition\n`;
            out += `‚Ä¢ HTA must intensify advocacy for streamlined US visa processing\n`;
            return out;
        }

        // Utilities
        function parseDateSafe(value) {
            // ÂÖºÂÆπ "YYYY-MM-DD" / ISO / ÂÖ∂‰ªñÂèØË¢´ Date Ëß£ÊûêÁöÑÊ†ºÂºèÔºõËß£ÊûêÂ§±Ë¥•Êó∂ËøîÂõû 0
            const t = Date.parse(value);
            return Number.isFinite(t) ? t : 0;
        }

        function escapeHtml(str) {
            return String(str ?? '')
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#39;');
        }

        // ÁÇπÈÄâ‰∫§‰∫íÔºöÂãæÈÄâ/ÂèñÊ∂àÊó∂Â∞ÜÊñ∞ÈóªÂä†ÂÖ•ÊàñÁßªÂá∫ selectedNewsÔºàÁî® selectedForReport Â≠ò idÔºâ
        function toggleNewsSelection(newsId) {
            generatedReportContent = '';
            if (selectedForReport.has(newsId)) selectedForReport.delete(newsId);
            else selectedForReport.add(newsId);
            renderNews();
        }

        function toggleAddToReport(newsId) {
            toggleNewsSelection(newsId);
        }

        // Ëé∑ÂèñÂΩìÂâçÈÄâ‰∏≠ÁöÑÊñ∞ÈóªÊï∞ÁªÑÔºàÊåâÊó•ÊúüÈôçÂ∫èÔºâ
        function getSelectedNewsArray() {
            return newsData
                .filter(n => selectedForReport.has(n._id))
                .sort((a, b) => parseDateSafe(b.date) - parseDateSafe(a.date));
        }

        // ÁÇπÂáª Generate ReportÔºöÂ∞Ü selectedNews ÂèëÁªôÂêéÁ´ØÔºåÊ∏≤ÊüìËøîÂõûÁöÑËã±ÊñáÊä•ÂëäÔºàÂê´ Competitor Environment„ÄÅConsumer and Travel TrendsÔºâ
        async function generateEnglishReport() {
            const selectedNews = getSelectedNewsArray();
            if (selectedNews.length === 0) {
                alert('Please select at least one news item.');
                return;
            }

            const btn = document.getElementById('generateReportBtn');
            if (btn) { btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...'; }
            reportContent.classList.remove('report-markdown');
            reportContent.innerHTML = '<div style="color: var(--gray);"><i class="fas fa-spinner fa-spin"></i> Generating report...</div>';
            lastReportPlainTextEn = '';

            const payload = selectedNews.map(n => ({
                title: n.title,
                summary: n.summary,
                date: n.date,
                source: n.source,
                categories: n.categories || [],
                insight: n.insight,
                url: n.url
            }));

            try {
                // ÁîüÊàêÊä•ÂëäÔºöPOST /api/generate-report
                const response = await fetch(`${API_URL}/generate-report`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ news: payload })
                });
                const result = await response.json();

                if (result.success && result.data) {
                    generatedReportContent = result.data;
                    lastReportPlainTextEn = result.data;
                    reportContent.classList.add('report-markdown');
                    reportContent.innerHTML = (typeof marked !== 'undefined' ? marked.parse(result.data) : escapeHtml(result.data).replace(/\n/g, '<br>'));
                } else {
                    reportContent.classList.remove('report-markdown');
                    reportContent.textContent = result.message || 'Report generation failed.';
                    if (result.message) console.warn('Report API:', result.message);
                }
            } catch (err) {
                console.error('Report generation failed:', err);
                reportContent.classList.remove('report-markdown');
                reportContent.textContent = 'Network error. Please try again.';
            }

            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-file-alt"></i> Generate Report';
            }
        }

        function updateReportContent(filteredNews) {
            // ÊúâÈÄâ‰∏≠‰ΩÜÂ∞öÊú™ÁîüÊàêÊä•ÂëäÔºöÂè™ÊòæÁ§∫ÊèêÁ§∫‰∏éÊï∞ÈáèÔºå‰∏çËá™Âä®Ë∞É API
            if (selectedForReport.size > 0) {
                const selected = filteredNews
                    .filter(n => selectedForReport.has(n._id))
                    .sort((a, b) => parseDateSafe(b.date) - parseDateSafe(a.date));

                if (selected.length === 0) {
                    reportContent.classList.remove('report-markdown');
                    reportContent.innerHTML = '<div style="color: var(--gray);">No items selected under current filters.</div>';
                    lastReportPlainTextEn = '';
                    return;
                }

                if (generatedReportContent) {
                    lastReportPlainTextEn = generatedReportContent;
                    reportContent.classList.add('report-markdown');
                    reportContent.innerHTML = (typeof marked !== 'undefined' ? marked.parse(generatedReportContent) : escapeHtml(generatedReportContent).replace(/\n/g, '<br>'));
                    return;
                }

                reportContent.classList.remove('report-markdown');
                reportContent.innerHTML = `<div style="color: var(--gray);">${selected.length} item${selected.length !== 1 ? 's' : ''} selected. Click <strong>Generate Report</strong> to create the English report (Competitor Environment & Consumer and Travel Trends).</div>`;
                lastReportPlainTextEn = '';
                return;
            }

            // Êó†ÈÄâ‰∏≠ÔºöÊòæÁ§∫ÂºïÂØºÊñáÊ°à
            lastReportPlainTextEn = '';
            reportContent.classList.remove('report-markdown');
            reportContent.textContent = 'Select news (checkbox) and click Generate Report.';
        }

        // Render news
        async function renderNews() {
            let filtered = newsData;
            
            if (currentSegment !== 'all') {
                filtered = filtered.filter(n => n.categories.includes(currentSegment));
            }
            
            if (showFavoritesOnly) {
                filtered = filtered.filter(n => favorites.includes(n._id));
            }

            // Êó∂Èó¥ÊéíÂ∫èÔºöÊåâ date ‰ªéÊñ∞Âà∞ÊóßÔºàÈôçÂ∫èÔºâ
            filtered = [...filtered].sort((a, b) => parseDateSafe(b.date) - parseDateSafe(a.date));
            
            // Update report (async when LLM is used for selected items)
            await updateReportContent(filtered);
            
            if (filtered.length === 0) {
                newsGrid.innerHTML = '';
                newsGrid.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            newsGrid.style.display = 'grid';
            emptyState.style.display = 'none';
            
            newsGrid.innerHTML = filtered.map(news => `
                <div class="news-card">
                    <div class="card-header">
                        <div class="card-categories">
                            ${(news.categories || []).map(cat => `
                                <span class="category-tag ${getCategoryClass(cat)}">${cat}</span>
                            `).join('')}
                            <div class="sentiment-selector" data-news-id="${news._id}">
                                <button type="button" class="sentiment-tag sentiment-tag--positive ${(news.sentiment || '‰∏≠Á´ã') === 'Âà©Â•Ω' ? 'active' : ''}" data-sentiment="Âà©Â•Ω" onclick="updateSentiment('${news._id}', 'Âà©Â•Ω', this)">Âà©Â•Ω</button>
                                <button type="button" class="sentiment-tag sentiment-tag--neutral ${(news.sentiment || '‰∏≠Á´ã') === '‰∏≠Á´ã' ? 'active' : ''}" data-sentiment="‰∏≠Á´ã" onclick="updateSentiment('${news._id}', '‰∏≠Á´ã', this)">‰∏≠Á´ã</button>
                                <button type="button" class="sentiment-tag sentiment-tag--negative ${(news.sentiment || '‰∏≠Á´ã') === 'Â®ÅËÉÅ' ? 'active' : ''}" data-sentiment="Â®ÅËÉÅ" onclick="updateSentiment('${news._id}', 'Â®ÅËÉÅ', this)">Â®ÅËÉÅ</button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <h3 class="news-title" onclick="window.open('${news.url}', '_blank')">${news.title}</h3>
                        <p class="news-summary">${news.summary}</p>
                        ${(news.insight && news.insight.trim()) ? `
                        <div class="insight-section">
                            <div class="insight-header">üí° HTC Strategic Insight</div>
                            <div class="insight-text">${news.insight.trim()}</div>
                        </div>
                        ` : `
                        <div class="insight-section">
                            <div class="insight-header">üí° HTC Strategic Insight</div>
                            <div class="insight-placeholder">Analyzing...</div>
                        </div>
                        `}
                        <div class="news-meta">
                            <span class="meta-item"><i class="far fa-calendar"></i> ${news.date}</span>
                            <span class="meta-item"><i class="far fa-newspaper"></i> ${news.source}</span>
                        </div>
                    </div>
                    <div class="card-actions">
                        <div class="left-actions">
                            <label class="report-checkbox" title="Add to report">
                                <input type="checkbox" ${selectedForReport.has(news._id) ? 'checked' : ''} onchange="toggleNewsSelection('${news._id}')">
                                Add to report
                            </label>
                            <button class="favorite-btn ${favorites.includes(news._id) ? 'active' : ''}" 
                                    onclick="toggleFavorite('${news._id}')"
                                    title="Favorites">
                                <i class="${favorites.includes(news._id) ? 'fas' : 'far'} fa-heart"></i>
                            </button>
                        </div>
                        <a href="${news.url}" target="_blank" class="read-more">
                            Read More <i class="fas fa-external-link-alt"></i>
                        </a>
                    </div>
                </div>
            `).join('');
        }

        // Helper functions
        function getCategoryClass(category) {
            const map = {
                '‰∏≠ÂõΩÂá∫Â¢ÉÊ∏∏Ë∂ãÂäø': 'tag-outbound',
                '‰∏≠ÂõΩÊ∂àË¥πË∂ãÂäø': 'tag-consumption',
                '‰∏≠ÂõΩÁªèÊµéË∂ãÂäø': 'tag-economy',
                'Short Haul': 'tag-short',
                'Long Haul': 'tag-long',
                'Visa Policy': 'tag-visa',
                'Flight Routes': 'tag-flight',
                'Market Data': 'tag-market',
                'Market Trend': 'tag-market'
            };
            return map[category] || 'tag-market';
        }

        function getSentimentClass(sentiment) {
            const map = { 'Âà©Â•Ω': 'sentiment-positive', 'Â®ÅËÉÅ': 'sentiment-negative', '‰∏≠Á´ã': 'sentiment-neutral' };
            return map[sentiment] || 'sentiment-neutral';
        }

        function getSentimentIcon(sentiment) {
            const map = { 'Âà©Â•Ω': 'fa-arrow-trend-up', 'Â®ÅËÉÅ': 'fa-arrow-trend-down', '‰∏≠Á´ã': 'fa-minus' };
            return map[sentiment] || 'fa-minus';
        }

        async function updateSentiment(newsId, sentiment, clickedBtn) {
            try {
                const res = await fetch(`/api/news/${newsId}`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sentiment })
                });
                if (!res.ok) throw new Error(await res.text());
                const container = clickedBtn.closest('.sentiment-selector');
                if (container) {
                    container.querySelectorAll('.sentiment-tag').forEach(btn => btn.classList.remove('active'));
                    clickedBtn.classList.add('active');
                }
            } catch (e) {
                console.error('Update sentiment failed:', e);
            }
        }

        // Copy report ‚Äî always copy the full English version
        function copyReport() {
            const text = lastReportPlainTextEn || reportContent.innerText || reportContent.textContent;
            navigator.clipboard.writeText(text).then(() => {
                alert('Report copied to clipboard!');
            });
        }

        // Filter event listeners
        document.getElementById('segmentFilters').addEventListener('click', (e) => {
            if (e.target.classList.contains('filter-btn')) {
                document.querySelectorAll('#segmentFilters .filter-btn').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                currentSegment = e.target.dataset.segment;
                renderNews();
            }
        });

        document.getElementById('showFavoritesBtn').addEventListener('click', (e) => {
            showFavoritesOnly = !showFavoritesOnly;
            e.target.classList.toggle('active');
            renderNews();
        });
    </script>
</body>
</html>
