<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HTC Market Intelligence</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #0066cc; --bg: #f4f7fe; --text: #2b3674;
            --green: #05cd99; --red: #e31a1a; --gray: #a3aed0;
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; }
        * { box-sizing: border-box; }

        /* Header */
        header { background: white; height: 64px; padding: 0 30px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 50; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .logo { font-size: 20px; font-weight: 800; color: var(--primary); display: flex; gap: 8px; align-items: center; }

        /* Layout & Controls */
        .layout { max-width: 1400px; margin: 24px auto; display: grid; grid-template-columns: 1fr 360px; gap: 24px; padding: 0 20px; }
        .controls { grid-column: 1/-1; background: white; padding: 20px 25px; border-radius: 20px; display: flex; flex-direction: column; gap: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); }

        .counter-box { display: flex; align-items: center; gap: 10px; font-size: 13px; font-weight: 600; color: var(--text); border-bottom: 1px solid #f0f0f0; padding-bottom: 12px; margin-bottom: 5px;}
        .filter-row { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        .filter-label { font-size: 12px; font-weight: 700; color: var(--gray); text-transform: uppercase; min-width: 85px; }

        .pill { border: 1px solid #e0e5f2; background: white; padding: 8px 16px; border-radius: 30px; font-size: 13px; font-weight: 600; color: var(--text); cursor: pointer; transition: 0.2s; }
        .pill:hover { border-color: var(--primary); color: var(--primary); background: #f8faff; }
        .pill.active { background: var(--primary); color: white; border-color: var(--primary); }

        .pill.pos.active { background: var(--green); border-color: var(--green); }
        .pill.neg.active { background: var(--red); border-color: var(--red); }
        .pill.fav.active { background: #ff5b5b; color: white; border-color: #ff5b5b; }

        /* Cards */
        .news-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; }
        .card { background: white; border-radius: 16px; padding: 20px; display: flex; flex-direction: column; box-shadow: 0 4px 10px rgba(0,0,0,0.02); transition: 0.2s; cursor: pointer; border: 2px solid transparent; position: relative; }
        .card:hover { transform: translateY(-4px); box-shadow: 0 15px 30px rgba(0,0,0,0.08); }
        .card.selected { border-color: var(--primary); background: #f4faff; }

        .fav-icon { position: absolute; top: 20px; right: 20px; font-size: 18px; color: #e0e5f2; cursor: pointer; transition: 0.2s; z-index: 10; }
        .fav-icon:hover { transform: scale(1.2); }
        .fav-icon.active { color: #ff5b5b; }

        .tags-row { display: flex; gap: 6px; margin-bottom: 12px; flex-wrap: wrap; padding-right: 30px; }
        .tag { font-size: 10px; padding: 4px 8px; border-radius: 4px; font-weight: 800; text-transform: uppercase; }
        .tag.industry { background: #E6F0FF; color: #0052cc; }
        .tag.pos { background: #E6F7F1; color: #00B69B; }
        .tag.neg { background: #FFF0F0; color: #E31A1A; }
        .tag.neu { background: #F4F7FE; color: #858D9D; }

        .card-title { font-size: 16px; font-weight: 700; margin: 0 0 10px 0; line-height: 1.5; color: #1B2559; }
        .card-summary { font-size: 13px; color: #707EAE; line-height: 1.6; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden; flex-grow: 1; }

        .insight { background: linear-gradient(90deg, #F4F7FE 0%, #ffffff 100%); border-left: 4px solid var(--primary); padding: 12px; border-radius: 0 8px 8px 0; margin-top: 15px; }
        .insight h4 { margin: 0 0 5px 0; font-size: 11px; color: var(--primary); text-transform: uppercase; }
        .insight p { margin: 0; font-size: 12px; color: #2B3674; font-weight: 500; }

        .footer { margin-top: 15px; display: flex; justify-content: space-between; align-items: center; border-top: 1px solid #f0f0f0; padding-top: 10px; font-size: 11px; color: #A3AED0; }

        /* Sidebar */
        .sidebar { position: sticky; top: 100px; height: fit-content; }
        .panel { background: white; padding: 25px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.03); }
        .gen-btn { width: 100%; background: var(--primary); color: white; padding: 14px; border-radius: 12px; border: none; font-weight: 700; margin-top: 20px; cursor: pointer; transition: 0.2s; }
        .gen-btn:hover { background: #0052cc; transform: translateY(-2px); }

        .lang-btn { border: none; background: transparent; padding: 6px 14px; border-radius: 16px; font-size: 12px; font-weight: 700; color: #a0aec0; cursor: pointer; }
        .lang-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        .user-area { display: flex; gap: 15px; align-items: center; }
        .login-btn {
            background: #2b3674; color: white; border: none; padding: 8px 20px;
            border-radius: 20px; font-size: 13px; font-weight: 600; cursor: pointer;
            transition: 0.2s; display: flex; gap: 6px; align-items: center;
        }
        .login-btn:hover { background: #4318FF; }
        .user-info { font-size: 13px; font-weight: 700; color: var(--text); display: none; align-items: center; gap: 8px; }

        /* Login Modal */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000; display: none;
            justify-content: center; align-items: center; backdrop-filter: blur(4px);
        }
        .login-box {
            background: white; padding: 30px; border-radius: 20px; width: 320px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2); text-align: center;
        }
        .login-box h3 { margin: 0 0 20px 0; color: var(--text); }
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; font-size: 12px; font-weight: 700; color: var(--gray); margin-bottom: 5px; }
        .input-group input {
            width: 100%; padding: 10px; border: 1px solid #e0e5f2; border-radius: 10px; outline: none; transition: 0.2s;
        }
        .input-group input:focus { border-color: var(--primary); }
        .submit-btn {
            width: 100%; background: var(--primary); color: white; padding: 12px;
            border: none; border-radius: 10px; font-weight: 700; cursor: pointer; margin-top: 10px;
        }
        .submit-btn:hover { background: #0052cc; }
        .error-msg { color: var(--red); font-size: 12px; margin-top: 10px; display: none; }

        @media (max-width: 1000px) { .layout { grid-template-columns: 1fr; } .sidebar { display: none; } }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <i class="fas fa-radar" style="color:var(--primary)"></i>
            <span data-t="brand">HTC Intelligence</span>
        </div>
        <div class="user-area">
            <div style="background:#f4f7fe; padding:4px; border-radius:20px; display:flex;">
                <button class="lang-btn active" onclick="setLang('cn')">ä¸­</button>
                <button class="lang-btn" onclick="setLang('en')">EN</button>
            </div>
            <button id="loginBtn" class="login-btn" onclick="showLoginModal()">
                <i class="fas fa-lock"></i> Login
            </button>
            <div id="userInfo" class="user-info">
                <span><i class="fas fa-user-check"></i> Hawaii Team</span>
                <i class="fas fa-sign-out-alt" onclick="handleLogout()" style="cursor:pointer; color:var(--gray); margin-left:8px;" title="Logout"></i>
            </div>
        </div>
    </header>

    <div id="loginModal" class="modal-overlay">
        <div class="login-box">
            <h3>HTC Team Login</h3>
            <div class="input-group">
                <label>Username</label>
                <input type="text" id="username" placeholder="Enter username">
            </div>
            <div class="input-group">
                <label>Password</label>
                <input type="password" id="password" placeholder="Enter password">
            </div>
            <button class="submit-btn" onclick="submitLogin()">Access Intelligence</button>
            <div id="loginError" class="error-msg">Incorrect credentials</div>
            <div style="margin-top:15px; font-size:11px; color:#aaa; cursor:pointer;" onclick="closeLoginModal()">Cancel</div>
        </div>
    </div>

    <div class="layout">
        <div class="controls">
            <div class="counter-box">
                <i class="fas fa-chart-pie" style="color:var(--primary)"></i>
                <span id="counterText">Loading...</span>
                <div style="flex-grow:1"></div>
                <select id="monthSelect" style="padding:6px 12px; border-radius:8px; border:1px solid #e0e0e0; outline:none; font-size:12px; background:#f9f9f9; cursor:pointer;">
                    <option value="all">ğŸ“… All Time</option>
                </select>
            </div>

            <div class="filter-row">
                <span class="filter-label" data-t="lbl_cat">Segment:</span>
                <button class="pill active" data-group="cat" data-val="all" data-t="all">All News</button>
                <button class="pill" data-group="cat" data-val="Outbound Trend" data-t="cat_out">Outbound Trend</button>
                <button class="pill" data-group="cat" data-val="Consumption Trend" data-t="cat_con">Consumption</button>
                <button class="pill" data-group="cat" data-val="Short Haul" data-t="cat_sh">Short Haul</button>
                <button class="pill" data-group="cat" data-val="Long Haul" data-t="cat_lh">Long Haul</button>
                <button class="pill" data-group="cat" data-val="Macro Economy" data-t="cat_eco">Economy</button>
            </div>

            <div class="filter-row">
                <span class="filter-label" data-t="lbl_sent">Sentiment:</span>
                <button class="pill active" data-group="sent" data-val="all" data-t="all">All</button>
                <button class="pill pos" data-group="sent" data-val="pos" data-t="sent_pos">Positive</button>
                <button class="pill neg" data-group="sent" data-val="neg" data-t="sent_neg">Threat</button>
                <div style="flex-grow:1"></div>
                <button class="pill fav" data-group="fav" onclick="toggleFavFilter(this)" data-t="fav">
                    <i class="fas fa-heart"></i> Favorites
                </button>
            </div>
        </div>

        <div class="news-grid" id="grid"></div>

        <aside class="sidebar">
            <div class="panel">
                <h3 data-t="rep_title">Executive Summary</h3>
                <p data-t="rep_desc" style="font-size:13px; color:var(--gray);">Select items to generate report.</p>
                <div id="selCount" style="color:var(--primary); font-weight:800; font-size:18px; margin:15px 0;">0 items</div>
                <div id="reportOut" style="font-size:12px; color:#555; white-space:pre-wrap; max-height:300px; overflow-y:auto;"></div>
                <button class="gen-btn" onclick="generateReport()" data-t="btn_gen">Generate Report</button>
            </div>
        </aside>
    </div>

    <script>
        const I18N = {
            cn: {
                brand: "HTC å¸‚åœºæƒ…æŠ¥ä¸­å¿ƒ", lbl_cat: "å¸‚åœºåˆ†ç±»:", lbl_sent: "æƒ…æ„Ÿç­›é€‰:",
                all: "å…¨éƒ¨æƒ…æŠ¥", cat_out: "å‡ºå¢ƒæ¸¸è¶‹åŠ¿", cat_con: "æ¶ˆè´¹è¶‹åŠ¿", cat_sh: "çŸ­çº¿ç«å¯¹", cat_lh: "é•¿çº¿ç«å¯¹", cat_eco: "å®è§‚ç»æµ",
                sent_pos: "åˆ©å¥½æ¶ˆæ¯", sent_neg: "å¨èƒ/è­¦æŠ¥", sent_neu: "ä¸­ç«‹", fav: "æˆ‘çš„æ”¶è—",
                rep_title: "é«˜ç®¡æ‘˜è¦æŠ¥å‘Š", rep_desc: "å‹¾é€‰æ–°é—»ä»¥ç”Ÿæˆæˆ˜ç•¥å»ºè®®", btn_gen: "ç”Ÿæˆæˆ˜ç•¥æŠ¥å‘Š",
                add: "åŠ å…¥æŠ¥å‘Š", orig: "é˜…è¯»åŸæ–‡", insight: "HTC æˆ˜ç•¥æ´å¯Ÿ",
                count_fmt: "æƒ…æŠ¥åº“å…± {total} æ¡ï¼Œå½“å‰ç­›é€‰æ˜¾ç¤º <span class='count-badge'>{shown}</span> æ¡"
            },
            en: {
                brand: "HTC Intelligence", lbl_cat: "Segment:", lbl_sent: "Sentiment:",
                all: "All News", cat_out: "Outbound Trend", cat_con: "Consumption", cat_sh: "Short Haul", cat_lh: "Long Haul", cat_eco: "Economy",
                sent_pos: "Positive", sent_neg: "Threat/Alert", sent_neu: "Neutral", fav: "Favorites",
                rep_title: "Executive Summary", rep_desc: "Select items for report", btn_gen: "Generate Report",
                add: "Add to Report", orig: "Source", insight: "HTC Insight",
                count_fmt: "Total {total} items, showing <span class='count-badge'>{shown}</span>"
            }
        };

        let CUR_LANG = 'cn';
        let NEWS = [], FILTERED = [], SELECTED = new Set();
        let FILTERS = { cat: 'all', sent: 'all', month: 'all', fav: false };
        let USER = localStorage.getItem('htc_user_token');
        let FAVS = JSON.parse(localStorage.getItem('htc_favs') || '[]');

        window.onload = async () => {
            checkLogin();
            initMonths();
            await fetchNews();
            setLang('cn');
        };

        // --- ç™»å½•ç³»ç»Ÿ (Team Access) ---
        function checkLogin() {
            if (USER === 'verified') {
                document.getElementById('loginBtn').style.display = 'none';
                document.getElementById('userInfo').style.display = 'flex';
            } else {
                document.getElementById('loginBtn').style.display = 'flex';
                document.getElementById('userInfo').style.display = 'none';
            }
        }

        window.showLoginModal = () => {
            document.getElementById('loginModal').style.display = 'flex';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('loginError').style.display = 'none';
        }

        window.closeLoginModal = () => {
            document.getElementById('loginModal').style.display = 'none';
        }

        window.submitLogin = () => {
            const u = document.getElementById('username').value;
            const p = document.getElementById('password').value;

            // âš ï¸ ç¡¬æ ¸éªŒè¯é€»è¾‘
            if (u === 'Hawaii' && p === 'Hawaii2026') {
                localStorage.setItem('htc_user_token', 'verified');
                USER = 'verified';
                checkLogin();
                closeLoginModal();
                alert('Access Granted. Welcome, HTC Team.');
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        }

        window.handleLogout = () => {
            if(confirm('Log out from HTC Intelligence?')) {
                localStorage.removeItem('htc_user_token');
                USER = null;
                checkLogin();
                window.location.reload();
            }
        };

        window.toggleHeart = (e, id) => {
            e.stopPropagation();
            if (!USER) {
                showLoginModal(); // æœªç™»å½•ç‚¹å‡»æ”¶è—ï¼Œç›´æ¥å¼¹å‡ºç™»å½•æ¡†
                return;
            }

            if (FAVS.includes(id)) {
                FAVS = FAVS.filter(fid => fid !== id);
            } else {
                FAVS.push(id);
            }
            localStorage.setItem('htc_favs', JSON.stringify(FAVS));
            applyFilters();
        };

        function initMonths() {
            const sel = document.getElementById('monthSelect');
            const now = new Date();
            for(let i=0; i<6; i++) {
                const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
                const val = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
                sel.add(new Option(d.toLocaleDateString(undefined, {year:'numeric',month:'short'}), val));
            }
            sel.onchange = (e) => { FILTERS.month = e.target.value; applyFilters(); };
        }

        async function fetchNews() {
            try {
                const res = await fetch('/api/news');
                const json = await res.json();
                NEWS = Array.isArray(json) ? json.sort((a,b) => new Date(b.date) - new Date(a.date)) : [];
                applyFilters();
            } catch(e) {
                console.error('Failed to fetch news:', e);
            }
        }

        function applyFilters() {
            FILTERED = NEWS.filter(n => {
                if (FILTERS.fav) return FAVS.includes(n._id);
                const cats = (n.categories || []).join('|');
                let catMatch = FILTERS.cat === 'all' || cats.includes(FILTERS.cat);
                const s = (n.sentiment || '').toLowerCase();
                let sentMatch = FILTERS.sent === 'all';
                if (!sentMatch) {
                    if (FILTERS.sent === 'pos') sentMatch = s.includes('pos') || s.includes('åˆ©å¥½');
                    else if (FILTERS.sent === 'neg') sentMatch = s.includes('neg') || s.includes('threat') || s.includes('å¨èƒ');
                }
                let monthMatch = FILTERS.month === 'all' || n.date.startsWith(FILTERS.month);
                return catMatch && sentMatch && monthMatch;
            });
            render(FILTERED);
        }

        function render(list) {
            const T = I18N[CUR_LANG];
            document.getElementById('counterText').innerHTML = T.count_fmt.replace('{total}', NEWS.length).replace('{shown}', list.length);

            document.getElementById('grid').innerHTML = list.map(item => {
                const title = CUR_LANG==='cn' ? (item.title_cn||item.title) : item.title;
                const summary = CUR_LANG==='cn' ? (item.summary_cn||item.summary) : item.summary;
                const insight = CUR_LANG==='cn' ? (item.insight_cn||item.insight) : (item.insight_en||item.insight);

                const s = (item.sentiment || '').toLowerCase();
                let color = 'neu', label = T.sent_neu;
                if (s.includes('neg') || s.includes('threat') || s.includes('å¨èƒ')) { color='neg'; label=T.sent_neg; }
                else if (s.includes('pos') || s.includes('åˆ©å¥½')) { color='pos'; label=T.sent_pos; }

                const bigCats = ['Short Haul', 'Long Haul', 'Consumption Trend', 'Outbound Trend', 'Market Trend'];
                const tags = (item.categories||[]).filter(c => !bigCats.includes(c)).slice(0,3)
                    .map(c => `<span class="tag industry">${c}</span>`).join('');

                const isFav = FAVS.includes(item._id);
                const heartClass = isFav ? 'fas fa-heart active' : 'far fa-heart';
                const heartStyle = isFav ? 'color:#ff5b5b;' : '';

                return `
                <div class="card ${SELECTED.has(item._id)?'selected':''}" onclick="window.open('${item.url}')">
                    <i class="${heartClass} fav-icon" style="${heartStyle}" onclick="toggleHeart(event, '${item._id}')"></i>

                    <div class="tags-row">
                        <span class="tag ${color}">${label}</span>
                        ${tags}
                    </div>
                    <div class="card-title">${title}</div>
                    <div class="card-summary">${summary}</div>
                    <div class="insight">
                        <h4><i class="fas fa-lightbulb"></i> ${T.insight}</h4>
                        <p>${insight}</p>
                    </div>
                    <div class="footer" onclick="event.stopPropagation()">
                        <span style="color:#888;"><i class="far fa-calendar"></i> ${item.date}</span>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <label style="display:flex; gap:6px; align-items:center; cursor:pointer; font-weight:600; color:var(--text);">
                                <input type="checkbox" onchange="toggleSel('${item._id}')" ${SELECTED.has(item._id)?'checked':''}> ${T.add}
                            </label>
                            <span style="color:var(--primary)">${T.orig} &rarr;</span>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        document.querySelectorAll('.pill').forEach(btn => {
            if(btn.dataset.group === 'fav') return;
            btn.onclick = (e) => {
                const group = e.target.dataset.group;
                FILTERS[group] = e.target.dataset.val;
                document.querySelectorAll(`.pill[data-group="${group}"]`).forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                applyFilters();
            };
        });

        window.toggleFavFilter = (btn) => {
            if (!USER) { showLoginModal(); return; }
            FILTERS.fav = !FILTERS.fav;
            btn.classList.toggle('active');
            applyFilters();
        };

        window.setLang = (l) => {
            CUR_LANG = l;
            document.querySelectorAll('.lang-btn').forEach(b => b.classList.toggle('active', b.innerText.toLowerCase().includes(l==='cn'?'ä¸­':'en')));
            document.querySelectorAll('[data-t]').forEach(el => el.innerText = I18N[l][el.dataset.t]);
            render(FILTERED);
        };

        window.toggleSel = (id) => {
            if(SELECTED.has(id)) SELECTED.delete(id); else SELECTED.add(id);
            document.getElementById('selCount').innerText = `${SELECTED.size} items`;
            render(FILTERED);
        };

        window.generateReport = async () => {
            if (!USER) { showLoginModal(); return; } // ç”ŸæˆæŠ¥å‘Šä¹Ÿéœ€è¦ç™»å½•
            const selItems = NEWS.filter(n => SELECTED.has(n._id));
            if(selItems.length === 0) { alert('Please select news first!'); return; }

            const reportBox = document.getElementById('reportOut');
            const btn = document.querySelector('.gen-btn');

            // ğŸŒŸ æ™ºèƒ½åˆ¤æ–­ï¼šæ£€æµ‹æ˜¯å¦é€‰æ‹©äº†å®è§‚ç»æµæ–°é—»
            const hasEconomyItems = selItems.some(n => (n.categories || []).includes('Macro Economy'));
            const isEcoReport = hasEconomyItems && selItems.every(n => (n.categories || []).includes('Macro Economy'));
            const apiEndpoint = isEcoReport ? '/api/report_economy' : '/api/report';
            const reportType = isEcoReport ? "Economic Briefing" : "Strategy Report";

            reportBox.innerHTML = `<div style="text-align:center; padding:30px; color:var(--primary);">
                <i class="fas fa-circle-notch fa-spin"></i> Generating ${reportType}...</div>`;
            btn.disabled = true;

            try {
                const res = await fetch(apiEndpoint, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ items: selItems })
                });
                const json = await res.json();

                if (json.success) {
                    // é€šç”¨æ¸²æŸ“é€»è¾‘
                    let html = json.report
                        .replace(/^# (.*)/gm, '<h3 style="color:#2b3674; margin-bottom:10px; border-bottom:2px solid #eee; padding-bottom:5px;">$1</h3>')
                        .replace(/^## (.*)/gm, '<h4 style="color:var(--primary); margin-top:20px; margin-bottom:5px;">$1</h4>')
                        .replace(/^### (.*)/gm, '<h5 style="color:#444; font-weight:800; margin-top:10px;">$1</h5>')
                        .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
                        .replace(/\n/g, '<br>');
                    reportBox.innerHTML = html;
                }
            } catch(e) { reportBox.innerText = "Error generating report."; }
            finally { btn.disabled = false; }
        };
    </script>
</body>
</html>
